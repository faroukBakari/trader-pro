name: CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ main ]

env:
  BACKEND_PORT: 8000
  FRONTEND_PORT: 5173
  VITE_API_URL: http://localhost:8000
  FRONTEND_URL: http://localhost:5173

jobs:
  # Backend setup and linting (runs once)
  backend-setup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache Poetry dependencies
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: backend/.venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('backend/poetry.lock') }}-v2

    - name: Install backend dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      working-directory: backend
      run: make install-ci

    - name: Generate all specs and clients
      working-directory: backend
      run: make generate

    - name: Upload backend specs
      uses: actions/upload-artifact@v4
      with:
        name: backend-specs-${{ github.sha }}
        path: |
          backend/src/trading_api/modules/*/specs_generated/*.json
        retention-days: 1

    - name: Run backend linting
      working-directory: backend
      run: make type-check

  # Backend boundary tests (runs once, enforces module isolation)
  backend-boundaries:
    runs-on: ubuntu-latest
    needs: [backend-setup]
    if: success()
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Restore cached venv
      uses: actions/cache@v3
      with:
        path: backend/.venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('backend/poetry.lock') }}-v2
        fail-on-cache-miss: false

    - name: Run import boundary tests
      working-directory: backend
      run: make test-boundaries

  # Backend module tests (runs in parallel per module)
  backend-modules:
    runs-on: ubuntu-latest
    needs: [backend-setup]
    if: success()
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
        module: ["broker", "datafeed"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Restore cached venv
      uses: actions/cache@v3
      with:
        path: backend/.venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('backend/poetry.lock') }}-v2
        fail-on-cache-miss: false

    - name: Run ${{ matrix.module }} module tests
      working-directory: backend
      run: make test-module-${{ matrix.module }}

  # Backend integration tests (runs once, requires all modules)
  backend-integration:
    runs-on: ubuntu-latest
    needs: [backend-boundaries, backend-modules]
    if: success()
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Restore cached venv
      uses: actions/cache@v3
      with:
        path: backend/.venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('backend/poetry.lock') }}-v2
        fail-on-cache-miss: false

    - name: Run all tests with coverage (final report)
      working-directory: backend
      run: make test-integration # make test-cov

  # Backend spec import and check
  backend-spec-import:
    runs-on: ubuntu-latest
    needs: [backend-integration]
    if: success()

    steps:
    - uses: actions/checkout@v4

    - name: Download backend specs from backend-setup
      uses: actions/download-artifact@v4
      with:
        name: backend-specs-${{ github.sha }}
        path: backend/src/trading_api/modules/

    - name: Verify all module specs exist
      working-directory: backend
      run: |
        echo "üîç Verifying per-module specs (reused from backend-setup)..."
        FAILED=0
        
        # Check broker specs (versioned)
        if [ ! -f "src/trading_api/modules/broker/specs_generated/broker_v1_openapi.json" ]; then
          echo "‚ùå Broker v1 OpenAPI spec not found"
          FAILED=1
        else
          echo "‚úÖ Broker v1 OpenAPI spec found"
        fi
        
        if [ ! -f "src/trading_api/modules/broker/specs_generated/broker_v1_asyncapi.json" ]; then
          echo "‚ùå Broker v1 AsyncAPI spec not found"
          FAILED=1
        else
          echo "‚úÖ Broker v1 AsyncAPI spec found"
        fi
        
        # Check datafeed specs (versioned)
        if [ ! -f "src/trading_api/modules/datafeed/specs_generated/datafeed_v1_openapi.json" ]; then
          echo "‚ùå Datafeed v1 OpenAPI spec not found"
          FAILED=1
        else
          echo "‚úÖ Datafeed v1 OpenAPI spec found"
        fi
        
        if [ ! -f "src/trading_api/modules/datafeed/specs_generated/datafeed_v1_asyncapi.json" ]; then
          echo "‚ùå Datafeed v1 AsyncAPI spec not found"
          FAILED=1
        else
          echo "‚úÖ Datafeed v1 AsyncAPI spec found"
        fi
        
        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "‚ùå Some specs are missing. Artifact download may have failed."
          exit 1
        fi
        
        echo ""
        echo "‚úÖ All per-module specs verified successfully"

  frontend:
    runs-on: ubuntu-latest
    needs: [backend-spec-import]
    if: success()
    strategy:
      matrix:
        node-version: ["22"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Download backend specs
      uses: actions/download-artifact@v4
      with:
        name: backend-specs-${{ github.sha }}
        path: backend/src/trading_api/modules/

    - name: Install frontend dependencies
      working-directory: frontend
      run: make install-ci

    - name: Generate per-module frontend clients (offline from specs)
      working-directory: frontend
      run: make generate

    - name: Verify per-module client generation
      working-directory: frontend
      run: |
        if [ ! -d "src/clients_generated/trader-client-broker_v1" ]; then
          echo "‚ùå Broker client generation failed - no trader-client-broker_v1 directory"
          exit 1
        fi
        if [ ! -d "src/clients_generated/trader-client-datafeed_v1" ]; then
          echo "‚ùå Datafeed client generation failed - no trader-client-datafeed_v1 directory"
          exit 1
        fi
        if [ ! -d "src/clients_generated/ws-types-broker_v1" ]; then
          echo "‚ùå Broker WebSocket types generation failed - no ws-types-broker_v1 directory"
          exit 1
        fi
        if [ ! -d "src/clients_generated/ws-types-datafeed_v1" ]; then
          echo "‚ùå Datafeed WebSocket types generation failed - no ws-types-datafeed_v1 directory"
          exit 1
        fi
        echo "‚úÖ Per-module REST clients and WebSocket types generated successfully"

    - name: Install Git hooks
      run: |
        git config core.hooksPath .githooks
        chmod +x .githooks/*

    - name: Run frontend linting
      working-directory: frontend
      run: make lint
      env:
        CI: true

    - name: Run frontend type checking
      working-directory: frontend
      run: make type-check
      env:
        CI: true

    - name: Run frontend tests
      working-directory: frontend
      run: make test
      env:
        CI: true

    - name: Build frontend
      working-directory: frontend
      run: make build

  integration:
    runs-on: ubuntu-latest
    needs: [backend-integration, frontend]
    if: success()
    strategy:
      matrix:
        python-version: ["3.11"]
        node-version: ["22"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Restore cached venv
      uses: actions/cache@v3
      with:
        path: backend/.venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('backend/poetry.lock') }}-v2
        fail-on-cache-miss: false

    - name: Generate all specs and clients
      working-directory: backend
      run: make generate

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      working-directory: frontend
      run: make install-ci

    - name: Generate per-module frontend clients (offline from specs)
      working-directory: frontend
      run: make generate

    - name: Build frontend against live API
      working-directory: frontend
      run: npm run build
      env:
        VITE_API_URL: http://localhost:8000

